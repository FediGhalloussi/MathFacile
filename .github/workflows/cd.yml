name: ğŸš€ CD

on:
  workflow_run:
    workflows: ["ğŸ§ª CI"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”½ Checkout
        uses: actions/checkout@v3

      - name: ğŸ” Login to GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin

      - name: ğŸ›  Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: ğŸ§ª Copier les .env d'exemple
        run: |
          cp backend/.env.example backend/.env
          cp frontend/.env.example frontend/.env

      - name: ğŸ³ Compile WebAssembly (wasm)
        run: docker-compose run --rm wasm

      - name: ğŸ³ Build & push backend image
        run: |
          docker build -t ghcr.io/${{ secrets.GHCR_USERNAME }}/mathfacile-backend:latest ./backend
          docker push ghcr.io/${{ secrets.GHCR_USERNAME }}/mathfacile-backend:latest

      - name: ğŸ³ Build & push frontend image
        run: |
          docker build -t ghcr.io/${{ secrets.GHCR_USERNAME }}/mathfacile-frontend:latest ./frontend
          docker push ghcr.io/${{ secrets.GHCR_USERNAME }}/mathfacile-frontend:latest
